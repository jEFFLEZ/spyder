import { resolveWorkspaces, spawnLogged, ensureNodeOptionsNoDeprecation, isPowerShell, tryInstallDeps } from "./utils.js";
import { WorkspaceLogger } from "./logger.js";
/** rome run <workspace> [-- cmd...] */
export async function runOne(ws, cmd, outputOptions) {
    const logger = new WorkspaceLogger(ws, outputOptions || { plain: false, json: false, noEmoji: false, ci: false });
    const map = resolveWorkspaces();
    const target = map[ws];
    if (!target) {
        logger.error(`Rome: workspace "${ws}" introuvable. Connus: ${Object.keys(map).join(", ") || "aucun"}`);
        process.exit(1);
    }
    if (isPowerShell())
        ensureNodeOptionsNoDeprecation();
    const fullCommand = cmd || "npm run dev";
    // Parse la commande pour séparer cmd et args
    const [command, ...args] = fullCommand.split(/\s+/);
    // Essaie d'abord la commande
    const child = spawnLogged(command, args, target, ws);
    // Si c'est npm run dev et qu'il échoue rapidement, tente d'installer les deps
    if (fullCommand === "npm run dev") {
        let hasFailed = false;
        child.on("exit", async (code) => {
            if (code !== 0 && !hasFailed) {
                hasFailed = true;
                logger.info(`Échec détecté, tentative d'installation automatique...`);
                const installed = await tryInstallDeps(target, ws);
                if (installed) {
                    logger.info(`Redémarrage après installation...`);
                    // Redémarre la commande après installation
                    const child2 = spawnLogged(command, args, target, ws);
                    const stop2 = () => { try {
                        child2.kill("SIGINT");
                    }
                    catch { } process.exit(0); };
                    process.on("SIGINT", stop2);
                    process.on("SIGTERM", stop2);
                }
            }
        });
    }
    const stop = () => { try {
        child.kill("SIGINT");
    }
    catch { } process.exit(0); };
    process.on("SIGINT", stop);
    process.on("SIGTERM", stop);
}
