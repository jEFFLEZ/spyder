import fs from "fs";
import path from "path";
import { execSync } from "child_process";
import { resolveWorkspaces, isPowerShell, ensureNodeOptionsNoDeprecation } from "./utils.js";
import { globalLogger } from "./logger.js";
/** fixPath(target?, cmd?) — target optionnel, auto via workspaces si omis */
export function fixPath(target, cmd) {
    const map = resolveWorkspaces();
    const cwd = process.cwd();
    const resolveTarget = () => {
        if (target && map[target])
            return map[target];
        // si déjà un package.json ici, reste
        if (fs.existsSync(path.join(cwd, "package.json")))
            return cwd;
        // sinon, prend le premier workspace trouvé
        const first = Object.values(map)[0];
        return first || cwd;
    };
    const dest = resolveTarget();
    if (dest !== cwd)
        process.chdir(dest);
    if (isPowerShell())
        ensureNodeOptionsNoDeprecation();
    if (cmd) {
        try {
            execSync(cmd, { stdio: "inherit", env: process.env });
        }
        catch (e) {
            globalLogger.error(`Rome: ${e?.message ?? e}`);
        }
    }
}
