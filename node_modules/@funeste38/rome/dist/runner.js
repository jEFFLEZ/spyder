import { spawn } from "node:child_process";
import http from "node:http";
import path from "node:path";
import fs from "node:fs";
import { globalLogger } from "./logger.js";
function loadConfig() {
    const configPath = path.resolve("rome.config.json");
    if (fs.existsSync(configPath)) {
        return JSON.parse(fs.readFileSync(configPath, "utf-8"));
    }
    return {
        server: {
            cwd: "server",
            command: "npm run dev",
            healthUrl: "http://localhost:4000/health",
            readyText: "Server running on port 4000",
        },
        checks: [{ name: "api", url: "http://localhost:4000/api/matches" }],
    };
}
function httpPing(url) {
    return new Promise((resolve) => {
        const req = http.get(url, (res) => {
            res.resume();
            resolve(res.statusCode || 0);
        });
        req.on("error", () => resolve(0));
        req.setTimeout(2000, () => {
            req.destroy();
            resolve(0);
        });
    });
}
export async function devAll() {
    const cfg = loadConfig();
    const root = process.cwd();
    const serverPath = path.join(root, cfg.server.cwd);
    globalLogger.info(`\nðŸ—ï¸  Rome Dev â€” Dossier : ${serverPath}`);
    globalLogger.info(`â–¶ï¸  DÃ©marrage : ${cfg.server.command}\n`);
    const proc = spawn(cfg.server.command, { cwd: serverPath, shell: true, stdio: "inherit" });
    const checks = cfg.checks ?? [];
    const timers = [];
    if (cfg.server.healthUrl) {
        const t = setInterval(async () => {
            const code = await httpPing(cfg.server.healthUrl);
            process.stdout.write(`\rðŸ©º  ${cfg.server.healthUrl} â†’ ${code || "..."}   `);
        }, 2000);
        timers.push(t);
    }
    for (const c of checks) {
        const every = c.intervalMs ?? 5000;
        const t = setInterval(async () => {
            const code = await httpPing(c.url);
            globalLogger.info(`\nðŸ”Ž  ${c.name} â†’ ${code || "Erreur"} (${c.url})`);
        }, every);
        timers.push(t);
    }
    const stop = () => {
        globalLogger.info("\nðŸ›‘  ArrÃªt du serveur...");
        proc.kill("SIGINT");
        timers.forEach(clearInterval);
        process.exit(0);
    };
    process.on("SIGINT", stop);
    process.on("SIGTERM", stop);
}
