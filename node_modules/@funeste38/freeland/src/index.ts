export type Decoder = (input: string) => Promise<string> | string;

const registry = new Map<string, Decoder>();

export function registerSystem(prefix: string, decoder: Decoder) {
  registry.set(prefix, decoder);
}

export async function decodeSystemValue(raw: string): Promise<string> {
  for (const [prefix, decoder] of registry) {
    if (raw.startsWith(prefix)) {
      const tail = raw.slice(prefix.length);
      const res = decoder(tail);
      return res instanceof Promise ? await res : res;
    }
  }
  // fallback: return raw
  return raw;
}

// built-ins
registerSystem('json:', (s) => JSON.parse(s));
registerSystem('b64:', (s) => Buffer.from(s, 'base64').toString('utf8'));
registerSystem('file:', (s) => {
  // simple sync read
  const fs = require('fs');
  const path = require('path');
  const p = path.resolve(s);
  return fs.readFileSync(p, 'utf8');
});
registerSystem('nez:', (s) => `nez:${s}`);
