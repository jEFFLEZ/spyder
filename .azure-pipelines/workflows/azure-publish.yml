trigger:
  - none

pr:
  - none

name: $(Build.BuildId)

stages:
  - stage: BuildAndPublish
    displayName: Build and publish QFlush extension
    jobs:
      - job: build
        displayName: Build
        pool:
          # Use self-hosted pool similarly to the publish job
          name: '$(AGENT_POOL)'
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              npm install --no-audit --no-fund
              npm run build
            displayName: 'Install and build'

      - job: publish
        displayName: Publish to Azure DevOps Marketplace
        dependsOn: build
        pool:
          # Use a self-hosted agent pool name provided via the pipeline variable AGENT_POOL.
          # Example: set AGENT_POOL=self-hosted in Pipeline variables after creating an agent pool.
          name: '$(AGENT_POOL)'
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
          - script: |
              echo "Validating required variables..."
              if [ -z "${PUBLISHER_ID}" ]; then echo "PUBLISHER_ID pipeline variable is required"; exit 1; fi
              if [ -z "${AZURE_DEVOPS_EXT_PAT}" ]; then echo "AZURE_DEVOPS_EXT_PAT pipeline variable is required"; exit 1; fi
            displayName: 'Validate variables'
          - script: |
              npm install -g tfx-cli@0.7.0
            displayName: 'Install tfx-cli'
          - script: |
              # package the extension into a .vsix (assumes vss-extension.json in extensions/vscode-npz)
              cd extensions/vscode-npz || exit 0
              if [ ! -f vss-extension.json ]; then echo "vss-extension.json not found in extensions/vscode-npz"; exit 1; fi
              # create vsix using tfx
              tfx extension create --manifest-globs vss-extension.json --output-path ../ || true
            displayName: 'Create VSIX package'
          - script: |
              cd extensions/vscode-npz || exit 0
              # find vsix file
              VSIX_FILE=$(ls ../*.vsix | head -n 1)
              if [ -z "$VSIX_FILE" ]; then echo "VSIX file not found"; exit 1; fi
              echo "Publishing $VSIX_FILE to Azure DevOps Marketplace with publisher ${PUBLISHER_ID}"
              # publish using tfx and PAT
              tfx extension publish --manifest-globs vss-extension.json --publisher ${PUBLISHER_ID} --token ${AZURE_DEVOPS_EXT_PAT} --service-url https://marketplace.visualstudio.com/
            displayName: 'Publish to Azure DevOps Marketplace'
