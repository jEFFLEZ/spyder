#!/usr/bin/env bash
# Lightweight launcher to run the qflush NPZ daemon without npm
# Also acts as a proxy for npm commands to avoid conflicts: npz ci/install/build/test/package --cwd <dir>
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
NODE_CMD="${NODE:-node}"

# simple ANSI colors (for coding semantics)
C_RESET="\033[0m"
C_GREEN="\033[32m"
C_YELLOW="\033[33m"
C_RED="\033[31m"
C_BLUE="\033[34m"

function color_print() {
  local color="$1"; shift
  echo -e "${color}$*${C_RESET}"
}

function run_in_cwd() {
  local cwd="$1"; shift
  if [ -z "$cwd" ]; then cwd="$DIR"; fi
  pushd "$cwd" > /dev/null || return 1
  "$@"
  local rc=$?
  popd > /dev/null || return 1
  return $rc
}

# help
if [ "$1" = "help" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  color_print "$C_BLUE" "npz - qflush NPZ helper"
  echo
  color_print "$C_GREEN" "Usage: npz <command> [args]"
  echo
  echo "Commands (examples):"
  color_print "$C_GREEN" "  npz run qflush" "\tStart the qflush pipeline or daemon"
  color_print "$C_GREEN" "  npz ci --cwd <dir>" "\tRun npm ci in target directory (uses npm internally)"
  color_print "$C_GREEN" "  npz install --cwd <dir>" "\tRun npm install --no-audit --no-fund"
  color_print "$C_GREEN" "  npz build --cwd <dir>" "\tRun npm run build in target directory"
  color_print "$C_GREEN" "  npz test --cwd <dir>" "\tRun npm test in target directory"
  color_print "$C_GREEN" "  npz info" "\tShow NPZ namespace and local daemon status"
  color_print "$C_GREEN" "  npz checksum" "\tShow pourparler checksum (from CSS or daemon)"
  echo
  color_print "$C_YELLOW" "Colors: green=ok yellow=warning red=error"
  exit 0
fi

# info: show namespace (from Node util) and daemon status
if [ "$1" = "info" ] || [ "$1" = "checksum" ]; then
  # namespace via node helper if available
  NS="$(node -e 'try{const c=require("./dist/utils/npz-config").default; if(c && c.getNpzNamespace) console.log(c.getNpzNamespace()); }catch(e){}' 2>/dev/null)"
  if [ -z "$NS" ]; then NS="(unknown)"; fi
  color_print "$C_BLUE" "NPZ namespace: $NS"
  # check daemon
  if command -v curl >/dev/null 2>&1; then
    OUT=$(curl -sS http://localhost:4500/status 2>/dev/null || true)
    if [ -n "$OUT" ]; then
      color_print "$C_GREEN" "Daemon: reachable -> $OUT"
    else
      color_print "$C_YELLOW" "Daemon: not reachable on http://localhost:4500"
    fi
    # checksum via daemon
    if [ "$1" = "checksum" ]; then
      CHK=$(curl -sS -X POST http://localhost:4500/npz/pourparler -H 'Content-Type: application/json' -d '{"action":"checksum"}' 2>/dev/null || true)
      if [ -n "$CHK" ]; then
        color_print "$C_GREEN" "Checksum (daemon): $CHK"
      fi
    fi
  else
    color_print "$C_YELLOW" "Daemon: curl not available to check status"
  fi
  # fallback: read CSS file locally
  if [ "$1" = "checksum" ]; then
    CSS="${DIR}/extensions/vscode-npz/pourparler-checksum.css"
    if [ -f "$CSS" ]; then
      GREP=$(grep -E "--npz-pourparler-checksum:" "$CSS" | sed -E "s/.*'([a-f0-9]+)'.*/\1/" || true)
      if [ -n "$GREP" ]; then
        color_print "$C_GREEN" "Checksum (local): $GREP"
      else
        color_print "$C_YELLOW" "Checksum not found in $CSS"
      fi
    else
      color_print "$C_YELLOW" "CSS checksum file not found: $CSS"
    fi
  fi
  exit 0
fi

# dispatcher: support `npz run qflush`
if [ "$1" = "run" ] && [ "$2" = "qflush" ]; then
  CLI="$DIR/dist/cli.js"
  if [ -f "$CLI" ]; then
    exec "$NODE_CMD" "$CLI" run qflush "${@:3}"
  else
    # fallback to starting the daemon if CLI not built
    exec "$NODE_CMD" "$DIR/dist/daemon/qflushd.js" "${@:3}"
  fi
fi

# proxy npm-like commands to avoid requiring 'npm' directly in workflows
case "$1" in
  ci|install|build|test|package)
    CMD="$1"
    shift
    # parse optional --cwd argument
    TARGET_CWD="$DIR"
    EXTRA_ARGS=()
    while [[ "$#" -gt 0 ]]; do
      case "$1" in
        --cwd)
          TARGET_CWD="$2"; shift 2;;
        --cwd=*)
          TARGET_CWD="${1#--cwd=}"; shift;;
        *)
          EXTRA_ARGS+=("$1"); shift;;
      esac
    done
    if [ "$CMD" = "ci" ]; then
      run_in_cwd "$TARGET_CWD" npm ci "${EXTRA_ARGS[@]}"
    elif [ "$CMD" = "install" ]; then
      run_in_cwd "$TARGET_CWD" npm install --no-audit --no-fund "${EXTRA_ARGS[@]}"
    elif [ "$CMD" = "build" ]; then
      run_in_cwd "$TARGET_CWD" npm run build "${EXTRA_ARGS[@]}"
    elif [ "$CMD" = "test" ]; then
      run_in_cwd "$TARGET_CWD" npm test "${EXTRA_ARGS[@]}"
    elif [ "$CMD" = "package" ]; then
      run_in_cwd "$TARGET_CWD" npm run package "${EXTRA_ARGS[@]}"
    fi
    exit $?
    ;;
esac

# default: run daemon with any args forwarded
exec "$NODE_CMD" "$DIR/dist/daemon/qflushd.js" "$@"
