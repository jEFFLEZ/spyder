name: Create PR from branch

on:
  workflow_dispatch:
    inputs:
      head_branch:
        description: 'Branch name to create PR from'
        required: true
        default: 'feat/tools-encoders'
      base_branch:
        description: 'Target base branch'
        required: true
        default: 'main'
      title:
        description: 'PR title'
        required: true
        default: 'feat(tools): add encoders and css encoder/decoder'
      body:
        description: 'PR body'
        required: false
        default: 'Add tools: tools/rgba_brotli_oc8.py, tools/css_encode.js, tools/css_decode.js.'

jobs:
  create-pr:
    # prevent self-dispatch loops when workflow is invoked by GitHub Actions
    if: "${{ github.actor != 'github-actions[bot]' }}"
    runs-on: ubuntu-latest
    steps:
      - name: Create PR via REST API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_API_URL: https://api.github.com
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "ERROR: GITHUB_TOKEN is not available in environment." >&2
            exit 1
          fi
          echo "Creating PR from '${{ github.event.inputs.head_branch }}' -> '${{ github.event.inputs.base_branch }}'"
          payload=$(jq -n --arg title "${{ github.event.inputs.title }}" --arg head "${{ github.event.inputs.head_branch }}" --arg base "${{ github.event.inputs.base_branch }}" --arg body "${{ github.event.inputs.body }}" '{title:$title,head:$head,base:$base,body:$body}')
          echo "$payload" | jq .
          resp=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" -H "User-Agent: qflush-bot" "$GITHUB_API_URL/repos/${{ github.repository }}/pulls" -d @-)
          echo "$resp" | jq .
          url=$(echo "$resp" | jq -r .html_url)
          if [ "$url" = "null" ] || [ -z "$url" ]; then
            echo "Failed to create PR; response above." >&2
            exit 1
          fi
          echo "PR created: $url"
