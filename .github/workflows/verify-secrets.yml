name: Verify Action Secrets

on:
  workflow_dispatch: {}

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Verify AZURE_PAT
        env:
          AZURE_PAT: ${{ secrets.AZURE_PAT }}
        run: |
          if [ -z "$AZURE_PAT" ]; then echo "AZURE_PAT: MISSING"; exit 1; fi
          echo "AZURE_PAT: set"
          echo "Testing Azure DevOps connectivity..."
          curl -sS -u :"$AZURE_PAT" https://dev.azure.com/funesterie/_apis/connectionData -o /tmp/az.json || true
          if grep -q "authenticatedUser" /tmp/az.json; then echo "AZURE_PAT: OK"; else echo "AZURE_PAT: FAILED (check scopes)"; fi

      - name: Verify VSCE_TOKEN
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
        run: |
          if [ -z "$VSCE_TOKEN" ]; then echo "VSCE_TOKEN: MISSING"; exit 1; fi
          echo "VSCE_TOKEN: set"
          # basic check: call Azure DevOps REST with token
          curl -sS -u :"$VSCE_TOKEN" https://dev.azure.com/funesterie/_apis/connectionData -o /tmp/vsce.json || true
          if grep -q "authenticatedUser" /tmp/vsce.json; then echo "VSCE_TOKEN: OK"; else echo "VSCE_TOKEN: FAILED (check token/scopes)"; fi

      - name: Verify NPM_TOKEN
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then echo "NPM_TOKEN: MISSING"; exit 1; fi
          echo "NPM_TOKEN: set"
          curl -sS -H "Authorization: Bearer $NPM_TOKEN" https://registry.npmjs.org/-/whoami -o /tmp/npm.json || true
          if grep -q "username" /tmp/npm.json; then echo "NPM_TOKEN: OK"; else echo "NPM_TOKEN: FAILED"; fi

      - name: Verify OPEN_VSX_TOKEN
        env:
          OPEN_VSX_TOKEN: ${{ secrets.OPEN_VSX_TOKEN }}
        run: |
          if [ -z "$OPEN_VSX_TOKEN" ]; then echo "OPEN_VSX_TOKEN: MISSING"; exit 1; fi
          echo "OPEN_VSX_TOKEN: set"
          npm i -g @open-vsx/ovsx@1.0.3 >/dev/null 2>&1 || true
          if npx @open-vsx/ovsx whoami --pat "$OPEN_VSX_TOKEN" >/tmp/ovsx.out 2>&1; then echo "OPEN_VSX_TOKEN: OK"; else echo "OPEN_VSX_TOKEN: FAILED"; cat /tmp/ovsx.out || true; fi

      - name: Summary
        run: |
          echo "Verification complete. Check above step outputs for each token status."
