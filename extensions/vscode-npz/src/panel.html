<!doctype html>
<html>
  <head><meta charset="utf-8"></head>
  <body>
    <h3>qflush Panel</h3>

    <div>
      <label for="daemonUrl">Daemon URL:</label>
      <input id="daemonUrl" type="text" style="width:60%" />
    </div>
    <div>
      <label for="adminToken">Admin Token:</label>
      <input id="adminToken" type="password" style="width:60%" />
      <button id="save">Save</button>
    </div>

    <hr />
    <h4>License</h4>
    <div>
      <label for="licenseKey">License Key:</label>
      <input id="licenseKey" type="text" style="width:50%" />
      <button id="activate">Activate</button>
      <button id="status">Status</button>
    </div>
    <pre id="content">Loading...</pre>

    <hr />
    <h4>NPZ Scores</h4>
    <button id="refresh">Refresh Scores</button>
    <button id="reset">Reset Scores</button>

    <script>
      const vscode = acquireVsCodeApi();
      let DAEMON_URL = 'http://localhost:4500';
      let ADMIN_TOKEN = '';

      function setInputs() {
        const d = document.getElementById('daemonUrl');
        const t = document.getElementById('adminToken');
        if (d) d.value = DAEMON_URL;
        if (t) t.value = ADMIN_TOKEN || '';
      }

      async function fetchJson(url, opts) {
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error('fetch failed ' + res.status);
        return await res.json();
      }

      async function loadScores(){
        try {
          const url = `${DAEMON_URL.replace(/\/$/, '')}/npz/scores?token=${encodeURIComponent(ADMIN_TOKEN)}`;
          const data = await fetchJson(url);
          document.getElementById('content').innerText = JSON.stringify(data, null, 2);
        } catch (e) {
          document.getElementById('content').innerText = 'Error: ' + String(e);
        }
      }

      document.getElementById('refresh').addEventListener('click', loadScores);
      document.getElementById('reset').addEventListener('click', async ()=>{
        try {
          const url = `${DAEMON_URL.replace(/\/$/, '')}/npz/scores/reset?token=${encodeURIComponent(ADMIN_TOKEN)}`;
          await fetch(url, { method: 'POST' });
          loadScores();
        } catch (e) {
          document.getElementById('content').innerText = 'Error: ' + String(e);
        }
      });

      document.getElementById('save').addEventListener('click', () => {
        const d = (document.getElementById('daemonUrl') as HTMLInputElement).value;
        const t = (document.getElementById('adminToken') as HTMLInputElement).value;
        DAEMON_URL = d || DAEMON_URL;
        ADMIN_TOKEN = t || ADMIN_TOKEN;
        // send save message to extension to persist in settings
        vscode.postMessage({ type: 'saveConfig', daemonUrl: DAEMON_URL, token: ADMIN_TOKEN });
        loadScores();
      });

      document.getElementById('activate').addEventListener('click', async () => {
        const key = (document.getElementById('licenseKey') as HTMLInputElement).value;
        if (!key) { document.getElementById('content').innerText = 'Enter a license key'; return; }
        try {
          const url = `${DAEMON_URL.replace(/\/$/, '')}/license/activate`;
          const res = await fetchJson(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key }) });
          if (res && res.success) {
            vscode.postMessage({ type: 'licenseActivated', license: res.license });
            document.getElementById('content').innerText = 'License activated: ' + JSON.stringify(res.license, null, 2);
          } else {
            document.getElementById('content').innerText = 'Activation failed: ' + JSON.stringify(res, null, 2);
          }
        } catch (e) {
          document.getElementById('content').innerText = 'Error: ' + String(e);
        }
      });

      document.getElementById('status').addEventListener('click', async () => {
        try {
          const url = `${DAEMON_URL.replace(/\/$/, '')}/license/status`;
          const res = await fetchJson(url);
          document.getElementById('content').innerText = 'Status: ' + JSON.stringify(res, null, 2);
        } catch (e) {
          document.getElementById('content').innerText = 'Error: ' + String(e);
        }
      });

      // Listen for messages from the extension to receive config securely
      window.addEventListener('message', event => {
        const msg = event.data;
        if (msg && msg.type === 'config') {
          if (msg.daemonUrl) DAEMON_URL = msg.daemonUrl;
          if (msg.token) ADMIN_TOKEN = msg.token;
          setInputs();
          loadScores();
        } else if (msg && msg.type === 'saved') {
          const info = msg.info || 'saved';
          document.getElementById('content').innerText = String(info);
        }
      });

      // initial load in case no config arrives
      setTimeout(() => { setInputs(); loadScores(); }, 200);
    </script>
  </body>
</html>
