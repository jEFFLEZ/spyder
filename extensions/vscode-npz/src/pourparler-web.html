<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QFlush — Pourparler Web</title>
  <style>
    :root{--size:240px}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#0b0b0b;color:#ddd}
    .wrap{display:flex;gap:24px;align-items:flex-start}
    .panel{width:380px}
    textarea{width:100%;height:120px;background:#111;border:1px solid #222;color:#ddd;padding:8px;border-radius:6px}
    button{margin-top:8px;padding:8px 12px;border-radius:6px;border:0;background:#1e90ff;color:white;cursor:pointer}
    .web-container{position:relative;width:var(--size);height:var(--size);border-radius:50%;background:radial-gradient(circle at center, #050505 0%, #000 60%, #050505 100%);box-shadow:0 0 20px rgba(0,0,0,0.8);display:block}
    .web-circle{position:absolute;border-radius:50%;border:1px solid rgba(200,200,200,0.08);left:50%;top:50%;transform:translate(-50%,-50%)}
    .circle-1{width:36%;height:36%}
    .circle-2{width:64%;height:64%}
    .circle-3{width:92%;height:92%}
    .web-ray{position:absolute;left:50%;top:0;height:100%;width:2px;transform-origin:bottom center}
    .web-ray .dot{position:absolute;left:50%;transform:translateX(-50%);width:8px;height:8px;border-radius:50%;background:rgba(200,200,200,0.06);transition:all 0.18s}
    .web-ray .d-0{bottom:38%}
    .web-ray .d-1{bottom:56%}
    .web-ray .d-2{bottom:74%}
    /* rays rotation */
    .ray-0{transform:translateX(-50%) rotate(0deg)}
    .ray-1{transform:translateX(-50%) rotate(45deg)}
    .ray-2{transform:translateX(-50%) rotate(90deg)}
    .ray-3{transform:translateX(-50%) rotate(135deg)}
    .ray-4{transform:translateX(-50%) rotate(180deg)}
    .ray-5{transform:translateX(-50%) rotate(225deg)}
    .ray-6{transform:translateX(-50%) rotate(270deg)}
    .ray-7{transform:translateX(-50%) rotate(315deg)}
    /* activation */
    .web-ray .dot.on{background:#e6e6e6;box-shadow:0 0 8px rgba(230,230,230,0.9)}
    .web-container.web-valid{box-shadow:0 0 20px rgba(0,255,140,0.3)}
    .web-container.web-invalid{box-shadow:0 0 20px rgba(255,80,80,0.3)}
    .meta{font-size:13px;color:#bbb;margin-top:8px}
    .theme{margin-top:6px}
    .exports{margin-top:10px}
    .exports button{background:#28a745}
    .debug{margin-top:10px}
    .debug pre{background:#080808;padding:8px;border-radius:6px;color:#9ee}
    .indexer{margin-top:12px;border-top:1px solid rgba(255,255,255,0.03);padding-top:12px}
    .indexer input, .indexer select{width:100%;margin-top:6px;padding:6px;border-radius:6px;border:1px solid #222;background:#111;color:#ddd}
  </style>
</head>
<body>
  <h2>QFlush — Pourparler: toile checksum</h2>
  <div class="wrap">
    <div class="panel">
      <label for="msg">Message</label>
      <textarea id="msg" placeholder="Écris un message ici..."></textarea>
      <div>
        <button id="encode">Encode & Update toile</button>
        <button id="copy">Copy checksum</button>
      </div>
      <div class="meta">Checksum (hex): <span id="hex">—</span> — bits set: <span id="ones">0</span></div>
      <div class="theme">Thème: <select id="theme"><option value="spyder">Spyder</option><option value="rome">Rome</option><option value="bat">Bat</option></select></div>

      <div class="exports">
        <button id="exportSvg">Export SVG</button>
        <button id="exportPng">Export PNG</button>
      </div>

      <div class="indexer">
        <strong>Rome index tag</strong>
        <label for="filePath">File path (workspace relative)</label>
        <input id="filePath" placeholder="src/rome/module/foo.ts" />
        <label for="fileType">Type</label>
        <select id="fileType"><option value="module">module</option><option value="component">component</option><option value="service">service</option></select>
        <div style="display:flex;gap:8px;">
          <button id="computeTag">Compute & Save tag</button>
          <button id="copyTag">Copy tag</button>
        </div>
        <div class="meta">Tag: <span id="tagHex">—</span>  <small id="tagInfo"></small></div>
      </div>

      <div class="debug">
        <div><button id="list">List checksums</button> <button id="clear">Clear checksums</button></div>
        <pre id="dbg">---</pre>
      </div>
    </div>

    <div>
      <div id="web" class="web-container web-valid" style="--size:240px">
        <div class="web-circle circle-1"></div>
        <div class="web-circle circle-2"></div>
        <div class="web-circle circle-3"></div>

        <!-- 8 rays each with 3 dots (rings) -->
        <div class="web-ray ray-0"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-1"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-2"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-3"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-4"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-5"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-6"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
        <div class="web-ray ray-7"><div class="dot d-0"></div><div class="dot d-1"></div><div class="dot d-2"></div></div>
      </div>
    </div>
  </div>

  <script>
    const vscode = (window.acquireVsCodeApi && window.acquireVsCodeApi()) || null;

    // FNV-1a 32bit hash, returns unsigned 32-bit
    function fnv1a32(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193) >>> 0;
      }
      return h >>> 0;
    }

    function compute24bitHash(msg){
      const h = fnv1a32(msg);
      return h & 0x00ffffff; // lower 24 bits
    }

    function applyChecksumToWeb(container, hash24){
      // for 8 rays, 3 rings each, use bit at (ray*3 + ring)
      let ones = 0;
      for(let r=0;r<8;r++){
        const ray = container.querySelector('.ray-'+r);
        if(!ray) continue;
        for(let ring=0;ring<3;ring++){
          const bitIndex = r*3 + ring;
          const bitOn = ((hash24 >> bitIndex) & 1) === 1;
          const dot = ray.querySelector('.d-'+ring);
          if(dot) dot.classList.toggle('on', bitOn);
          if(bitOn) ones++;
        }
      }

      // visual mood: valid if even number of ones
      container.classList.toggle('web-valid', ones % 2 === 0);
      container.classList.toggle('web-invalid', ones % 2 === 1);
      return ones;
    }

    function toHex24(x){ return ('000000'+(x&0xffffff).toString(16)).slice(-6) }

    function collectState(){
      const web = document.getElementById('web');
      const size = parseInt(getComputedStyle(web).getPropertyValue('--size')) || 240;
      const dots = [];
      for(let r=0;r<8;r++){
        const ray = web.querySelector('.ray-'+r);
        for(let ring=0;ring<3;ring++){
          const dot = ray.querySelector('.d-'+ring);
          dots.push({ray:r,ring,active: dot.classList.contains('on')});
        }
      }
      const color = document.getElementById('theme').value === 'rome' ? '#f5d68b' : document.getElementById('theme').value === 'bat' ? '#9dd3ff' : '#e6e6e6';
      return {size,dots,color,hex:document.getElementById('hex').innerText.replace(/^0x/,'')};
    }

    function buildSVG(state){
      const s = state.size;
      const cx = s/2, cy = s/2;
      const radii = [s*0.74/2, s*0.56/2, s*0.36/2];
      const svgParts = [];
      svgParts.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 ${s} ${s}">`);
      svgParts.push(`<rect width="100%" height="100%" fill="#000"/>`);
      // circles
      for(const r of radii){ svgParts.push(`<circle cx="${cx}" cy="${cy}" r="${r}" stroke="rgba(200,200,200,0.08)" stroke-width="1" fill="none"/>`); }
      // dots
      state.dots.forEach(d=>{
        const angle = (d.ray * 45) * Math.PI/180; // degrees to rad
        const rr = radii[d.ring];
        const dx = cx + Math.sin(angle) * rr;
        const dy = cy - Math.cos(angle) * rr;
        const fill = d.active ? state.color : 'rgba(200,200,200,0.06)';
        svgParts.push(`<circle cx="${dx.toFixed(2)}" cy="${dy.toFixed(2)}" r="6" fill="${fill}" />`);
      });
      // center badge
      svgParts.push(`<circle cx="${cx}" cy="${cy}" r="12" fill="#111" stroke="#333"/>`);
      svgParts.push(`</svg>`);
      return svgParts.join('\n');
    }

    function exportSvgFile(){
      const state = collectState();
      const svg = buildSVG(state);
      const filename = `qflush-${state.hex || 'checksum'}.svg`;
      if(vscode) vscode.postMessage({ type:'export', format:'svg', data:svg, filename });
    }

    function exportPngFile(){
      const state = collectState();
      const svg = buildSVG(state);
      const img = new Image();
      const svgBlob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        canvas.width = state.size; canvas.height = state.size;
        const ctx = canvas.getContext('2d');
        // black background
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0);
        const dataUrl = canvas.toDataURL('image/png');
        const filename = `qflush-${state.hex || 'checksum'}.png`;
        if(vscode) vscode.postMessage({ type:'export', format:'png', data:dataUrl, filename });
        URL.revokeObjectURL(url);
      };
      img.onerror = ()=>{ URL.revokeObjectURL(url); alert('Export failed'); };
      img.src = url;
    }

    async function listChecksums(){
      if(!vscode) return;
      vscode.postMessage({ type: 'npzList' });
    }

    async function clearChecksums(){
      if(!vscode) return;
      vscode.postMessage({ type: 'npzClear' });
    }

    function computeAndSendTag(){
      const filePath = (document.getElementById('filePath') as HTMLInputElement).value || '';
      const fileType = (document.getElementById('fileType') as HTMLSelectElement).value || 'module';
      if(!filePath) return alert('Provide a workspace-relative file path');
      const tag = compute24bitHash(fileType + '|' + filePath);
      const hex = '0x'+toHex24(tag);
      document.getElementById('tagHex').innerText = hex;
      document.getElementById('tagInfo').innerText = `type=${fileType} path=${filePath}`;
      if(vscode) vscode.postMessage({ type: 'npzIndexTag', payload: { path: filePath, type: fileType, tag: hex } });
    }

    document.getElementById('computeTag').addEventListener('click', computeAndSendTag);
    document.getElementById('copyTag').addEventListener('click', ()=>{ const h = document.getElementById('tagHex').innerText; if(h && h!=='—') navigator.clipboard.writeText(h); });

    document.getElementById('encode').addEventListener('click', ()=>{
      const msg = document.getElementById('msg').value || '';
      const hash24 = compute24bitHash(msg);
      const web = document.getElementById('web');
      const ones = applyChecksumToWeb(web, hash24);
      document.getElementById('hex').innerText = '0x'+toHex24(hash24);
      document.getElementById('ones').innerText = ones;
      // thickness/color based on ones and theme
      const theme = document.getElementById('theme').value;
      const color = theme === 'rome' ? '#f5d68b' : theme === 'bat' ? '#9dd3ff' : '#e6e6e6';
      document.querySelectorAll('.web-ray .dot.on').forEach(el=>{
        el.style.background = color;
        el.style.boxShadow = '0 0 8px '+color;
      });

      document.querySelectorAll('.web-ray .dot:not(.on)').forEach(el=>{
        el.style.background = 'rgba(200,200,200,0.06)';
        el.style.boxShadow = 'none';
      });
    });

    document.getElementById('copy').addEventListener('click', ()=>{
      const hex = document.getElementById('hex').innerText;
      if(hex && hex !== '—') navigator.clipboard.writeText(hex);
    });

    document.getElementById('exportSvg').addEventListener('click', exportSvgFile);
    document.getElementById('exportPng').addEventListener('click', exportPngFile);
    document.getElementById('list').addEventListener('click', listChecksums);
    document.getElementById('clear').addEventListener('click', clearChecksums);

    document.getElementById('msg').addEventListener('input', ()=>document.getElementById('encode').click());

    // handle messages from extension
    window.addEventListener('message', event => {
      const msg = event.data;
      if(!msg) return;
      if(msg.type === 'npzListResult') {
        document.getElementById('dbg').innerText = JSON.stringify(msg.data, null, 2);
      } else if(msg.type === 'npzClearResult') {
        document.getElementById('dbg').innerText = 'Cleared: ' + JSON.stringify(msg.data);
      } else if(msg.type === 'exportSaved') {
        document.getElementById('dbg').innerText = 'Exported: ' + msg.path;
      } else if(msg.type === 'npzIndexTagResult') {
        if(msg.success) {
          document.getElementById('dbg').innerText = 'Index tag saved: ' + JSON.stringify(msg.record, null, 2);
        } else {
          document.getElementById('dbg').innerText = 'Index tag save failed: ' + String(msg.error);
        }
      }
    });

    // initialize with default sample
    document.getElementById('msg').value = 'bonjour qflush';
    document.getElementById('encode').click();
  </script>
</body>
</html>